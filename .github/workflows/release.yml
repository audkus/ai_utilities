# Release Pipeline - Production Deployment
#
# PURPOSE: Automated PyPI releases triggered by git tags
# TRIGGER: Git tags matching pattern v* (e.g., v1.0.0)
# BLOCKS RELEASES: Yes - failures prevent PyPI publication
# EXPECTED RUNTIME: ~10-15 minutes
#
# SAFETY: This is the ONLY path to PyPI. Manual uploads are not supported.

name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  validate-version:
    name: Version Consistency Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Extract version from tag
      id: tag-version
      run: |
        # Extract version from git tag (remove 'v' prefix)
        TAG_VERSION="${{ github.ref_name }}"
        VERSION="${TAG_VERSION#v}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Tag version: $VERSION"
    
    - name: Extract version from pyproject.toml
      id: toml-version
      run: |
        # Extract version from pyproject.toml
        VERSION=$(python -c "
        import tomllib
        with open('pyproject.toml', 'rb') as f:
            data = tomllib.load(f)
        print(data['project']['version'])
        ")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "pyproject.toml version: $VERSION"
    
    - name: Validate version consistency
      run: |
        TAG_VERSION="${{ steps.tag-version.outputs.version }}"
        TOML_VERSION="${{ steps.toml-version.outputs.version }}"
        
        if [[ "$TAG_VERSION" != "$TOML_VERSION" ]]; then
          echo "‚ùå VERSION MISMATCH:"
          echo "   Git tag: v$TAG_VERSION"
          echo "   pyproject.toml: $TOML_VERSION"
          echo ""
          echo "Fix: Update pyproject.toml version to match git tag"
          exit 1
        else
          echo "‚úÖ Version consistency validated: v$TAG_VERSION"
        fi

  test:
    name: Pre-release Tests
    runs-on: ubuntu-latest
    needs: validate-version
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install -e ".[dev]"
    
    - name: Run tests
      run: |
        pytest tests/ -v --tb=short
    
    - name: Type check
      run: |
        mypy src/ai_utilities/ --no-error-summary

  build:
    name: Build Package
    needs: [validate-version, test]
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install build dependencies
      run: |
        pip install build twine
    
    - name: Build package
      run: |
        python -m build
    
    - name: Check package
      run: |
        echo "Checking built package..."
        twine check dist/*
        echo "‚úÖ Package validation passed"
    
    - name: List built files
      run: |
        echo "Built files:"
        ls -la dist/
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-packages-${{ github.run_number }}
        path: dist/
        retention-days: 30

  publish:
    name: Publish to PyPI
    needs: build
    runs-on: ubuntu-latest
    environment: production  # Requires explicit approval
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: release-packages-${{ github.run_number }}
        path: dist/
    
    - name: Verify tag format
      run: |
        TAG="${{ github.ref_name }}"
        if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "‚ùå Invalid tag format: $TAG"
          echo "Expected format: v1.0.0"
          exit 1
        fi
        echo "‚úÖ Tag format validated: $TAG"
    
    - name: Upload to PyPI
      if: startsWith(github.ref, 'refs/tags/v')
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        echo "Publishing to PyPI..."
        twine upload dist/*
        echo "‚úÖ Published to PyPI successfully"

  create-release:
    name: Create GitHub Release
    needs: [validate-version, publish]
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Create Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release create ${{ github.ref_name }} --title "Release ${{ github.ref_name }}" --notes "
        ## Release ${{ github.ref_name }}
        
        See [CHANGELOG.md](https://github.com/audkus/ai_utilities/blob/main/CHANGELOG.md) for detailed changes.
        
        ### Installation
        \`\`\`bash
        pip install ai-utilities
        # or with providers
        pip install ai-utilities[openai]
        \`\`\`
        
        ### Verification
        - ‚úÖ Version consistency validated
        - ‚úÖ All tests passing
        - ‚úÖ Type checks passing
        - ‚úÖ Package validation passed
        - ‚úÖ Published to PyPI
        "

  notify:
    name: Release Results
    needs: [validate-version, test, build, publish, create-release]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Notify success
      if: ${{ needs.validate-version.result == 'success' && needs.test.result == 'success' && needs.build.result == 'success' && needs.publish.result == 'success' && needs.create-release.result == 'success' }}
      run: |
        echo "üéâ SUCCESS: Release ${{ github.ref_name }} completed successfully!"
        echo ""
        echo "‚úÖ Version consistency validated"
        echo "‚úÖ All tests passed"
        echo "‚úÖ Package built and validated"
        echo "‚úÖ Published to PyPI"
        echo "‚úÖ GitHub release created"
        echo ""
        echo "üì¶ Installation: pip install ai-utilities==${{ github.ref_name }}"
    
    - name: Notify failure
      if: ${{ needs.validate-version.result == 'failure' || needs.test.result == 'failure' || needs.build.result == 'failure' || needs.publish.result == 'failure' || needs.create-release.result == 'failure' }}
      run: |
        echo "‚ùå FAILED: Release ${{ github.ref_name }} failed!"
        echo ""
        echo "Version Check: ${{ needs.validate-version.result }}"
        echo "Tests: ${{ needs.test.result }}"
        echo "Build: ${{ needs.build.result }}"
        echo "Publish: ${{ needs.publish.result }}"
        echo "Release: ${{ needs.create-release.result }}"
        echo ""
        echo "üîß Check the workflow logs for details"
        exit 1
