# Release Pipeline - Validation and GitHub Release
#
# PURPOSE: Validate releases and create GitHub releases
# TRIGGER: Git tags matching pattern v* (e.g., v1.0.0, v1.0.0b1)
# BLOCKS RELEASES: Yes - failures prevent GitHub release creation
# EXPECTED RUNTIME: ~10-15 minutes
#
# NOTE: PyPI publishing is handled separately by publish.yml workflow

name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  validate-version:
    name: Version Consistency Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Extract version from tag
      id: tag-version
      run: |
        # Extract version from git tag (remove 'v' prefix)
        TAG_VERSION="${{ github.ref_name }}"
        VERSION="${TAG_VERSION#v}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Tag version: $VERSION"
    
    - name: Extract version from pyproject.toml
      id: toml-version
      run: |
        # Extract version from pyproject.toml
        VERSION=$(python -c "
        import tomllib
        with open('pyproject.toml', 'rb') as f:
            data = tomllib.load(f)
        print(data['project']['version'])
        ")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "pyproject.toml version: $VERSION"
    
    - name: Validate version consistency
      run: |
        TAG_VERSION="${{ steps.tag-version.outputs.version }}"
        TOML_VERSION="${{ steps.toml-version.outputs.version }}"
        
        if [[ "$TAG_VERSION" != "$TOML_VERSION" ]]; then
          echo "VERSION MISMATCH:"
          echo "   Git tag: v$TAG_VERSION"
          echo "   pyproject.toml: $TOML_VERSION"
          echo ""
          echo "Fix: Update pyproject.toml version to match git tag"
          exit 1
        else
          echo "Version consistency validated: v$TAG_VERSION"
        fi

  test:
    name: Pre-release Tests
    runs-on: ubuntu-latest
    needs: validate-version
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install -e ".[dev]"
    
    - name: Run tests
      run: |
        pytest tests/ -v --tb=short
    
    - name: Type check
      run: |
        mypy src/ai_utilities/ --no-error-summary

  build:
    name: Build Package
    needs: [validate-version, test]
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install build dependencies
      run: |
        pip install build twine
    
    - name: Build package
      run: |
        python -m build
    
    - name: Check package
      run: |
        echo "Checking built package..."
        twine check dist/*
        echo "Package validation passed"
    
    - name: List built files
      run: |
        echo "Built files:"
        ls -la dist/
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-packages-${{ github.run_number }}
        path: dist/
        retention-days: 30

  create-release:
    name: Create GitHub Release
    needs: [validate-version, test]
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Create Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release create ${{ github.ref_name }} --title "Release ${{ github.ref_name }}" --notes "
        ## Release ${{ github.ref_name }}
        
        See [CHANGELOG.md](https://github.com/audkus/ai_utilities/blob/main/CHANGELOG.md) for detailed changes.
        
        ### Installation
        \`\`\`bash
        pip install ai-utilities
        # or with providers
        pip install ai-utilities[openai]
        \`\`\`
        
        ### Verification
        - Version consistency validated
        - All tests passing
        - Type checks passing
        - Package validation passed
        - PyPI publishing handled by separate workflow
        "

  notify:
    name: Release Results
    needs: [validate-version, test, build, create-release]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Notify success
      if: ${{ needs.validate-version.result == 'success' && needs.test.result == 'success' && needs.build.result == 'success' && needs.create-release.result == 'success' }}
      run: |
        echo "SUCCESS: Release ${{ github.ref_name }} completed successfully!"
        echo ""
        echo "Version consistency validated"
        echo "All tests passed"
        echo "Package built and validated"
        echo "GitHub release created"
        echo "PyPI publishing handled by separate workflow"
        echo ""
        echo "Installation: pip install ai-utilities==${{ github.ref_name }}"
    
    - name: Notify failure
      if: ${{ needs.validate-version.result == 'failure' || needs.test.result == 'failure' || needs.build.result == 'failure' || needs.create-release.result == 'failure' }}
      run: |
        echo "FAILED: Release ${{ github.ref_name }} failed!"
        echo ""
        echo "Version Check: ${{ needs.validate-version.result }}"
        echo "Tests: ${{ needs.test.result }}"
        echo "Build: ${{ needs.build.result }}"
        echo "Release: ${{ needs.create-release.result }}"
        echo ""
        echo "Check the workflow logs for details"
        exit 1
