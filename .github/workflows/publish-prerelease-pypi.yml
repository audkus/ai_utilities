# PyPI Pre-release Publishing via Trusted Publishing
#
# PURPOSE: Publish pre-release packages to real PyPI for staging and testing
# TRIGGER: Git tags matching pattern v* (e.g., v1.0.0a1, v1.0.0b1, v1.0.0rc1) AND manual workflow_dispatch
# AUTHENTICATION: Uses PyPI Trusted Publishing (OIDC) - no secrets stored
# PUBLISHES: Pre-releases only to real PyPI for testing before production release

name: Publish Pre-release to PyPI

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

permissions:
  id-token: write  # Required for OIDC trusted publishing
  contents: read   # Required to checkout the repository

jobs:
  publish:
    name: Publish Pre-release to PyPI
    runs-on: ubuntu-latest
    
    # Only run for manual dispatch or pre-release tags
    if: >
      github.event_name == 'workflow_dispatch' || 
      (startsWith(github.ref, 'refs/tags/') && 
       (contains(github.ref_name, 'a') || contains(github.ref_name, 'b') || contains(github.ref_name, 'rc')) &&
       !contains(github.ref_name, '-'))
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install build dependencies
      run: python -m pip install --upgrade pip build
      
    - name: Clean previous build artifacts
      run: |
        rm -rf dist/ build/ *.egg-info
        echo "Cleaned previous build artifacts"
      
    - name: Build package
      run: python -m build
      
    - name: Verify built version
      run: |
        PYPROJECT_VERSION="$(python3 -c "try:\n    import tomllib\nexcept ImportError:\n    import tomli as tomllib\nprint(tomllib.loads(open('pyproject.toml', 'r').read())['project']['version'])")"
        echo "pyproject.toml version: $PYPROJECT_VERSION"

        if [ "${GITHUB_EVENT_NAME}" = "push" ]; then
          TAG="${GITHUB_REF_NAME#v}"
          echo "Tag version: $TAG"
          test "$TAG" = "$PYPROJECT_VERSION"
          EXPECT="$TAG"
        else
          EXPECT="$PYPROJECT_VERSION"
        fi

        echo "Built dist:"
        ls -la dist/
        python3 - << 'PY'
        import os, glob
        expect = os.environ["EXPECT"]
        files = glob.glob("dist/*")
        assert files, "dist/ is empty"
        assert any(expect in f for f in files), f"Expected version {expect} in dist files, got: {files}"
        PY
      env:
        EXPECT: ${{ github.ref_name }}
      
    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        verbose: true
        skip-existing: true

  smoke-install:
    name: Smoke Test Install from PyPI
    runs-on: ubuntu-latest
    needs: publish
    
    # Only run for manual dispatch or pre-release tags
    if: >
      github.event_name == 'workflow_dispatch' || 
      (startsWith(github.ref, 'refs/tags/') && 
       (contains(github.ref_name, 'a') || contains(github.ref_name, 'b') || contains(github.ref_name, 'rc')) &&
       !contains(github.ref_name, '-'))
    
    steps:
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Extract version from tag or pyproject
      run: |
        if [ "${GITHUB_EVENT_NAME}" = "push" ]; then
          # For tag pushes, use the tag version
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Using tag version: $VERSION"
        else
          # For workflow_dispatch, use pyproject version
          VERSION="$(python3 -c "try:\n    import tomllib\nexcept ImportError:\n    import tomli as tomllib\nprint(tomllib.loads(open('pyproject.toml', 'r').read())['project']['version'])")"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Using pyproject version: $VERSION"
        fi
        echo "Installing version: $VERSION"
        
    - name: Create virtual environment
      run: |
        python -m venv test_env
        source test_env/bin/activate
        python --version
        
    - name: Upgrade pip in venv
      run: |
        source test_env/bin/activate
        python -m pip install -U pip
        
    - name: Install from PyPI with retry
      run: |
        source test_env/bin/activate
        MAX_ATTEMPTS=6
        ATTEMPT=1
        
        while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
          echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: Installing ai-utilities==${VERSION}"
          
          if python -m pip install --no-cache-dir "ai-utilities==${VERSION}" --pre; then
            echo "Installation successful!"
            break
          else
            echo "Installation failed, attempt $ATTEMPT/$MAX_ATTEMPTS"
            echo "Full pip output:"
            python -m pip install --no-cache-dir "ai-utilities==${VERSION}" --pre || true
            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "All attempts failed. Please check PyPI for the package."
              exit 1
            fi
            echo "Waiting 10 seconds before retry..."
            sleep 10
            ATTEMPT=$((ATTEMPT + 1))
          fi
        done
        
    - name: Verify installation
      run: |
        source test_env/bin/activate
        
        # Test import and version
        IMPORTED_VERSION=$(python -c "import ai_utilities; print(ai_utilities.__version__)")
        echo "Imported version: $IMPORTED_VERSION"
        echo "Expected version: $VERSION"
        
        if [ "$IMPORTED_VERSION" != "$VERSION" ]; then
          echo "Version mismatch! Expected: $VERSION, Got: $IMPORTED_VERSION"
          exit 1
        fi
        
        # Test CLI help
        ai-utilities --help
        
        echo "Smoke test passed!"
