# Provider Health Monitor - Observational Only
#
# PURPOSE: Monitor external provider APIs for outages and changes
# BLOCKS PRs: No - NEVER runs on pull_request
# BLOCKS RELEASES: No - observational only
# EXPECTED RUNTIME: ~5-10 minutes
# DEPENDENCIES: External APIs and secrets - inherently flaky
#
# NOTE: This workflow is BEST EFFORT only. Failures here do not
# indicate problems with the library itself, but with external services.

name: Provider Health Monitor

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    # Allow manual runs
  # REMOVED: push triggers to avoid blocking development

jobs:
  provider-health-check:
    name: Provider Health Check (Observational)
    runs-on: ubuntu-latest
    continue-on-error: true  # Never block anything
    timeout-minutes: 10      # Explicit timeout to prevent hangs
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pytest python-dotenv requests
        
    - name: Check for required secrets
      id: check-secrets
      run: |
        # Check if any provider secrets are available
        if [[ -z "${{ secrets.AI_API_KEY }}" && -z "${{ secrets.GROQ_API_KEY }}" && -z "${{ secrets.TOGETHER_API_KEY }}" && -z "${{ secrets.OPENROUTER_API_KEY }}" ]]; then
          echo "skip=true" >> $GITHUB_OUTPUT
          echo "No provider API keys available - skipping health checks"
        else
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "Provider API keys found - proceeding with health checks"
        fi
        
    - name: Run Provider Health Monitor
      if: steps.check-secrets.outputs.skip == 'false'
      env:
        AI_API_KEY: ${{ secrets.AI_API_KEY }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        TOGETHER_API_KEY: ${{ secrets.TOGETHER_API_KEY }}
        OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      continue-on-error: true
      run: |
        timeout 300 python scripts/provider_health_monitor.py || echo "Health monitor timed out or failed - continuing"
        
    - name: Run Provider Change Detection
      if: steps.check-secrets.outputs.skip == 'false'
      env:
        AI_API_KEY: ${{ secrets.AI_API_KEY }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        TOGETHER_API_KEY: ${{ secrets.TOGETHER_API_KEY }}
        OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      continue-on-error: true
      run: |
        timeout 300 python scripts/provider_change_detector.py --generate-report || echo "Change detector timed out or failed - continuing"
        
    - name: Upload Health Report (Artifacts Only)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: provider-health-report-${{ github.run_number }}
        path: provider_report_*.md
        retention-days: 7  # Shorter retention for observational data
        
    - name: Summary Report
      if: always()
      run: |
        echo "## Provider Health Check Summary" >> $GITHUB_STEP_SUMMARY
        echo "**Status**: Observational (non-blocking)" >> $GITHUB_STEP_SUMMARY
        echo "**Run ID**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ steps.check-secrets.outputs.skip }}" == "true" ]]; then
          echo "**Skipped**: No API keys configured" >> $GITHUB_STEP_SUMMARY
        else
          echo "**Completed**: Health checks performed" >> $GITHUB_STEP_SUMMARY
          echo "**Results**: Check artifacts for detailed report" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Note" >> $GITHUB_STEP_SUMMARY
        echo "This is an observational workflow. Failures do not indicate" >> $GITHUB_STEP_SUMMARY
        echo "problems with the library, but with external provider services." >> $GITHUB_STEP_SUMMARY
