name: Create Release Tag

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  tag:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Read version from pyproject.toml
      id: ver
      run: |
        python - << 'PY' >> "$GITHUB_OUTPUT"
        import tomllib
        from pathlib import Path

        data = tomllib.loads(Path("pyproject.toml").read_bytes())
        version = data["project"]["version"]
        print(f"version={version}")
        PY

    - name: Validate version is stable
      run: |
        VERSION="${{ steps.ver.outputs.version }}"
        echo "Version: $VERSION"
        python - << 'PY'
        import os, re
        v = os.environ["VERSION"]
        # Reject pre-releases: a, b, rc and local versions
        if re.search(r"(a|b|rc)\d+|[-+]", v):
          raise SystemExit(f"Not a stable version: {v}")
        PY
      env:
        VERSION: ${{ steps.ver.outputs.version }}

    - name: Run unit tests
      run: |
        python -m pip install --upgrade pip
        python -m pip install -e ".[dev]"
        python -m pytest -m "not integration and not slow and not packaging and not hanging and not dashboard"

    - name: Create and push tag
      run: |
        VERSION="${{ steps.ver.outputs.version }}"
        TAG="v$VERSION"
        echo "Creating tag $TAG"
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a "$TAG" -m "$TAG"
        git push origin "$TAG"
