[tox]
envlist = py311,py312,coverage,coverage-full,integration,provider-check,packaging
skipsdist = True

[testenv]
deps = pytest
       pytest-cov
       pytest-mock
       pytest-json-report
       pytest-timeout
       pytest-randomly
       -e .[dev]
commands = pytest -m "not integration" {posargs}

[testenv:integration]
deps = pytest
       pytest-cov
       pytest-mock
       pytest-json-report
       pytest-timeout
       pytest-randomly
       python-dotenv
       -e .[dev]
setenv = AI_UTILITIES_LOAD_DOTENV = 1
commands = pytest -m integration {posargs}

[testenv:coverage]
deps =
    pytest
    pytest-mock
    pytest-json-report
    pytest-timeout
    pytest-randomly
    coverage[toml]
    -e .[dev]
commands =
    python -c "import shutil; shutil.rmtree('coverage_reports/html', ignore_errors=True)"
    python -c "from pathlib import Path; Path('coverage_reports/coverage.xml').unlink(missing_ok=True)"
    python -c "from pathlib import Path; Path('coverage_reports').mkdir(parents=True, exist_ok=True)"
    python -m coverage erase
    python -c "import subprocess, sys; result = subprocess.run([sys.executable, '-m', 'coverage', 'run', '-m', 'pytest', '-m', 'not integration'] + (sys.argv[1:] if len(sys.argv) > 1 else [])); print(f'TESTS_EXIT_CODE: {result.returncode}')" {posargs}
    python -c "import subprocess; subprocess.run(['python', '-m', 'coverage', 'combine'], capture_output=True)"
    python -c "import subprocess; subprocess.run(['python', '-m', 'coverage', 'report', '-m'], capture_output=True)"
    python -c "import subprocess; subprocess.run(['python', '-m', 'coverage', 'xml', '-o', 'coverage_reports/coverage.xml'], capture_output=True)"
    python -c "import subprocess; subprocess.run(['python', '-m', 'coverage', 'html', '-d', 'coverage_reports/html'], capture_output=True)"
ignore_outcome = true

[testenv:coverage-full]
deps =
    pytest
    pytest-mock
    pytest-json-report
    pytest-timeout
    pytest-randomly
    coverage[toml]
    python-dotenv
    -e .[dev]
setenv = AI_UTILITIES_LOAD_DOTENV = 1
commands =
    python -c "import shutil; shutil.rmtree('coverage_reports/html', ignore_errors=True)"
    python -c "from pathlib import Path; Path('coverage_reports/coverage.xml').unlink(missing_ok=True)"
    python -c "from pathlib import Path; Path('coverage_reports').mkdir(parents=True, exist_ok=True)"
    python -m coverage erase
    python -c "import subprocess, sys; result = subprocess.run([sys.executable, '-m', 'coverage', 'run', '-m', 'pytest'] + (sys.argv[1:] if len(sys.argv) > 1 else [])); print(f'TESTS_EXIT_CODE: {result.returncode}')" {posargs}
    python -c "import subprocess; subprocess.run(['python', '-m', 'coverage', 'combine'], capture_output=True)"
    python -c "import subprocess; subprocess.run(['python', '-m', 'coverage', 'report', '-m'], capture_output=True)"
    python -c "import subprocess; subprocess.run(['python', '-m', 'coverage', 'xml', '-o', 'coverage_reports/coverage.xml'], capture_output=True)"
    python -c "import subprocess; subprocess.run(['python', '-m', 'coverage', 'html', '-d', 'coverage_reports/html'], capture_output=True)"
ignore_outcome = true

[testenv:provider-check]
deps = pytest
       python-dotenv
       requests
       -e .[dev]
commands = python scripts/provider_change_detector.py
           python scripts/provider_change_detector.py --run-tests
           python scripts/provider_change_detector.py --generate-report

[testenv:packaging]
deps = build
       wheel
       pytest
       pytest-mock
commands =
    python -c "import shutil; shutil.rmtree('dist', ignore_errors=True)"
    python -m build
    # Run packaging tests only
    python -m pytest -m packaging -v --tb=short
